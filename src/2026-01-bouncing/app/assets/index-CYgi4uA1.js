(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))h(n);new MutationObserver(n=>{for(const s of n)if(s.type==="childList")for(const u of s.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&h(u)}).observe(document,{childList:!0,subtree:!0});function e(n){const s={};return n.integrity&&(s.integrity=n.integrity),n.referrerPolicy&&(s.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?s.credentials="include":n.crossOrigin==="anonymous"?s.credentials="omit":s.credentials="same-origin",s}function h(n){if(n.ep)return;n.ep=!0;const s=e(n);fetch(n.href,s)}})();const o={hwidth:100,hheight:100,initialSpeed:25,maxKESteps:60*60,physicsDt:1/200,maxDt:1/15,collisionBucketSize:4},k=[{name:"num-balls",default:2e3,min:100,max:3e4,step:500,title:"Num Balls"},{name:"radius",default:1.4,min:.2,max:4,step:.2,title:"Radius"},{name:"restitution",default:1,min:.95,max:1.01,step:.001,title:"Bounce, Ball"},{name:"temp-top",default:1,min:.1,max:2,step:.1,title:"Bounce, Top"},{name:"temp-bottom",default:1,min:.1,max:2,step:.1,title:"Bounce, Bottom"}];function S(c){for(let t=c.length-1;t>0;t--){const e=Math.floor(Math.random()*(t+1));[c[t],c[e]]=[c[e],c[t]]}return c}class E{constructor(){this.px=[],this.py=[],this.vx=[],this.vy=[],this.r=[],this.wallFactors={top:1,bottom:1,left:1,right:1},this.restitution=1,this.bucketNx=Math.ceil(o.hwidth*2/o.collisionBucketSize),this.bucketNy=Math.ceil(o.hheight*2/o.collisionBucketSize),this.buckets=new Array(this.bucketNx*this.bucketNy),this.bucketOrder=new Array(this.buckets.length);for(let t=0;t<this.buckets.length;t++)this.buckets[t]=[],this.bucketOrder[t]=t}get length(){return this.px.length}spawn(t,e,h,n,s){this.px.push(t),this.py.push(e),this.vx.push(h),this.vy.push(n),this.r.push(s)}remove(t){this.px.splice(0,t),this.py.splice(0,t),this.vx.splice(0,t),this.vy.splice(0,t),this.r.splice(0,t)}foreach(t){for(let e=0;e<this.px.length;e++)t(e)}updateCollisions(){const t=o.collisionBucketSize,e=this.bucketNx,h=this.bucketNy,n=this.buckets;for(let s=0;s<n.length;s++)n[s].length=0;this.foreach(s=>{const u=this.px[s]+o.hwidth,a=this.py[s]+o.hheight,i=this.r[s],r=Math.min(Math.max(Math.floor((u-i)/t),0),e-1),p=Math.min(Math.max(Math.floor((u+i)/t),0),e-1),b=Math.min(Math.max(Math.floor((a-i)/t),0),h-1),y=Math.min(Math.max(Math.floor((a+i)/t),0),h-1);for(let m=b;m<=y;m++)for(let d=r;d<=p;d++)n[m*e+d].push(s)}),S(this.bucketOrder);for(const s of this.bucketOrder){const u=n[s];for(const a of u)for(const i of u){if(a>=i)continue;const r=this.px[i]-this.px[a],p=this.py[i]-this.py[a],b=r*r+p*p,y=this.r[a]+this.r[i];if(b<y*y){const m=this.vx[a],d=this.vy[a],l=this.vx[i],f=this.vy[i];if(m*r+d*p-l*r-f*p>0){const g=m*r+d*p-l*r-f*p,x=this.restitution*g/b;this.vx[a]-=x*r,this.vy[a]-=x*p,this.vx[i]+=x*r,this.vy[i]+=x*p}}}}}update(t){this.updateCollisions(),this.foreach(e=>{let h=this.vx[e],n=this.vy[e],s=this.px[e]+this.vx[e]*t,u=this.py[e]+this.vy[e]*t;const a=this.r[e];s-a<-100&&(s=-100+a,h*=-1*this.wallFactors.left),s+a>o.hwidth&&(s=o.hwidth-a,h*=-1*this.wallFactors.right),u-a<-100&&(u=-100+a,n*=-1*this.wallFactors.top),u+a>o.hheight&&(u=o.hheight-a,n*=-1*this.wallFactors.bottom),this.px[e]=s,this.py[e]=u,this.vx[e]=h,this.vy[e]=n})}kineticEnergy(){let t=0;return this.foreach(e=>{t+=.5*(this.vx[e]*this.vx[e]+this.vy[e]*this.vy[e])}),t}}function B(c){const t=Math.min(c/(2*o.initialSpeed),1),e=Math.floor(255*t),h=0,n=(.5+.5*t)*Math.floor(255*(1-t));return`rgb(${e},${h},${n})`}class M{constructor(t){this.controlValues=t,this.lastTimeMs=null,this.keHistory=[],this.physicsDeltaT=0,this.balls=new E,this.updateControls()}spawn(){const t=this.controlValues.get("radius"),e=this.controlValues.get("num-balls");for(this.balls.length>=e&&this.balls.remove(this.balls.length-e),this.balls.foreach(h=>{this.balls.r[h]=t});this.balls.length<e;){const h=Math.random()*o.hwidth*2-o.hwidth,n=Math.random()*o.hheight*2-o.hheight,s=Math.random()*Math.PI*2,u=Math.cos(s)*o.initialSpeed,a=Math.sin(s)*o.initialSpeed;this.balls.spawn(h,n,u,a,t)}}updateControls(){this.balls.wallFactors.top=this.controlValues.get("temp-top"),this.balls.wallFactors.bottom=this.controlValues.get("temp-bottom"),this.balls.restitution=this.controlValues.get("restitution"),this.spawn()}update(t){if(this.lastTimeMs!==null){const e=Math.min((t-this.lastTimeMs)/1e3,o.maxDt);for(this.physicsDeltaT+=e;this.physicsDeltaT>=o.physicsDt;)this.balls.update(o.physicsDt),this.physicsDeltaT-=o.physicsDt}for(this.lastTimeMs=t,this.keHistory.push(this.balls.kineticEnergy());this.keHistory.length>o.maxKESteps;)this.keHistory.shift()}get ke(){return this.keHistory[this.keHistory.length-1]||0}}function v(c,t){return t<1?c.toFixed(Math.ceil(Math.log10(1/t))):c.toFixed(0)}function C(){const c=document.getElementById("fps-value");let t=0,e=0;const h=10;let n=null;return s=>{if(n!==null){const a=1/((s-n)/1e3);t=(t*e+a)/(e+1),e=Math.min(e+1,h),c.innerText=t.toFixed(0)}n=s}}window.onload=()=>{const c=new Map;k.forEach(i=>{c.set(i.name,i.default)});let t=new M(c);document.getElementById("btn-restart").onclick=()=>{t=new M(c)},k.forEach(i=>{const r=document.createElement("div");r.className="control-group";const p=v(i.default,i.step);r.innerHTML=`
        <div class="control-header">
            <label>${i.title}</label>
            <button class="btn-${i.name} btn-reset">DEFAULT</button>
        </div>
        <div class="button-row">
            <button class="btn-${i.name} btn-decrease"></button>
            <span id="label-${i.name}">${p}</span>
            <button class="btn-${i.name} btn-increase"></button>
        </div>
    `,document.getElementById("panel-side").appendChild(r);const b=document.getElementById(`label-${i.name}`),y=()=>{document.querySelectorAll(`.btn-${i.name}`).forEach(m=>{const d=m;d.classList.contains("btn-decrease")&&(d.disabled=c.get(i.name)<=i.min),d.classList.contains("btn-increase")&&(d.disabled=c.get(i.name)>=i.max)})};y(),document.querySelectorAll(`.btn-${i.name}`).forEach(m=>{if(m.classList.contains("btn-reset"))m.addEventListener("click",()=>{b.textContent=v(i.default,i.step),c.set(i.name,i.default),y(),t.updateControls()});else{const d=i.step*(m.classList.contains("btn-decrease")?-1:1);m.textContent=d>0?`+${d}`:`${d}`,m.addEventListener("click",()=>{let l=c.get(i.name);l+=d,l=Math.round(l/i.step)*i.step,l=Math.min(Math.max(l,i.min),i.max),b.textContent=v(l,i.step),c.set(i.name,l),y(),t.updateControls()})}})});const e=document.getElementById("canvas-main"),h=e.getContext("2d"),n=document.getElementById("canvas-ke"),s=n.getContext("2d"),u=C(),a=i=>{u(i),t.update(i);const r=t.balls;h.clearRect(0,0,e.width,e.height),h.strokeStyle="#000000",h.lineWidth=4,h.strokeRect(0,0,e.width,e.height),r.foreach(l=>{const f=(r.px[l]+o.hwidth)/(o.hwidth*2)*e.width,g=(r.py[l]+o.hheight)/(o.hheight*2)*e.height,x=r.r[l]/(o.hwidth*2)*e.width,w=Math.sqrt(r.vx[l]*r.vx[l]+r.vy[l]*r.vy[l]);h.fillStyle=B(w),h.beginPath(),h.arc(f,g,x,0,Math.PI*2),h.fill()});const p=document.getElementById("label-ke");p.innerText=`KE: ${(t.ke/1e3).toFixed(0)} k`,s.fillStyle="#dddddd",s.fillRect(0,0,n.width,n.height),s.beginPath();const b=t.keHistory.reduce((l,f)=>l>f?l:f,0),y=t.keHistory.reduce((l,f)=>l<f?l:f,b),m=Math.max(b-y,1e-4),d=.1;t.keHistory.forEach((l,f)=>{const g=f*(n.width/t.keHistory.length),x=n.height*(.5-(l-(y+b)/2)/(m*(1+d)));f===0?s.moveTo(g,x):s.lineTo(g,x)}),s.strokeStyle="#0000ff",s.lineWidth=2,s.stroke(),s.strokeStyle="#000000",requestAnimationFrame(a)};requestAnimationFrame(a)};
