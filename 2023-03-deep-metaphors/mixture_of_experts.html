<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
    <meta name="author" content="Douglas Orr" />
    <meta name="keywords" content="deep-learning,metaphors" />
    <link rel="stylesheet" href="/css/lib.css" />
    <link rel="stylesheet" href="/css/custom.css" />
    <script type="text/javascript" src="/js/custom.js" defer></script>
    <script type="text/javascript" src="/js/lib.js" defer></script>
    <title>Mixture of Experts</title>
  </head>

  <body>
    <nav class="navbar navbar-dark bg-dark">
      <a class="navbar-brand" href="/">Doug's Diversions</a>
    </nav>
    <div class="container dd-root">
      <div class="row">
        <div class="col"><h1 id="mixture-of-experts">Mixture of Experts</h1>
<p><strong>The metaphor</strong> <em>You're managing an editorial team at a newspaper. Each afternoon a large pile of stories is dumped on your desk (each a joint effort between LLM and prompter). You could get your team to each read every single one, and balance their opinions to process each manuscript. But that'd be slow, so you quickly skim each to categorise it, then pop it in the inbox of the sports/political/technology editor. Thanks to their expertise, you know they can do an accurate job quickly.</em></p>
<p><em>Mixture-of-Expert (MoE) layers classify incoming tokens, assigning each to an expert layer. Tokens are routed to their chosen layer, which processes them independently from the others. The outputs from each expert layer are routed back for further processing.</em></p>
<p><img alt="&quot;The editors&quot;, a poster for an upcoming movie, showing the editorial team." class="img-fluid" src="img/mixture_of_experts.png" />
<em>Image generated by Stable Diffusion 2.1, prompt: ""The editors", a poster for an upcoming movie, showing the editorial team."</em></p>
<p><strong>The good</strong> The metaphor has a good correspondence: editor &amp; classifier, internal mail &amp; routing, domain-editor &amp; expert layer, domain experience &amp; expert training data. It gives some intuition for what the token-expert classifier layer might be doing. And it encourages us to think about the subset of the training data that each expert sees.</p>
<p><strong>The bad</strong> Thinking of each routed layer as an <em>expert</em> is risky. In the metaphor, an expert's subject area is grounded and identifiable, but in the standard MoE example, they are not. In other words, experts define clusters, not classes.</p>
<p>So we'll probably get tied up in knots if we worry about what a given layer's "expertise" really is. It might not be anything we can identify as a legitimate speciality. Perhaps it's not a MoE layer at all, it's just a MaRoS (mapping a region of space) layer. OK, I just made that up (and it's not very good). But you get the idea—it's possible to move away from the metaphor into something more abstract.</p>
<p>If it's wrong, fine, but what's the danger? As with all shaky metaphors, it could mean we waste ourselves on bad ideas and dismiss good ones. Perhaps we think the assignment layer should be guided in order to do its job properly, based on identifiable classes. I'm sceptical. We think a stable random assignment could never work? See <a href="https://arxiv.org/abs/2106.04426">Hash Layers</a>.</p>
<p><strong>Conclusion</strong> It's a tempting metaphor, and seems quite good at first glance. But "experts" is a dangerously powerful term, and can bring along lots of baggage. I'll come down quite strongly on this one—I'd rather leave the layers abstract; so maybe I will still "MoE" for now, but I'll quietly try to forget what the "E" stands for.</p>
<hr />
<ul>
<li><a href="article.html">Introduction</a></li>
<li><a href="neural_network.html">A Neural Network</a></li>
<li><a href="loss_landscape.html">The Loss Landscape</a></li>
<li><a href="attention.html">Attention</a></li>
<li><strong>Mixture of Experts</strong></li>
<li>Finally, a <a href="conclusion.html">conclusion</a>, thanks for reading!</li>
</ul></div>
      </div>
      <div class="row dd-footer">
        <div class="col">
          <p>
            Note: All views or opinions expressed here are those of the author
            at time of writing and do not represent those of any employer or
            other organisation, past or present.
          </p>
          <p>
            Please let me know of errors or missing references by
            <a href="https://github.com/DouglasOrr/DouglasOrr.github.io/issues"
              >raising an issue on GitHub</a
            >.
          </p>
        </div>
      </div>
    </div>
  </body>
</html>
